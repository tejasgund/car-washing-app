<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Washing Center - Billing Management (API MOCKED)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* (*** YOUR CSS STYLES ARE HERE ***) */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --dark-bg: #1e293b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f5f9;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }

        .service-item {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .service-item:hover {
            border-color: var(--primary-color);
            background-color: #f8fafc;
        }

        .service-item input[type="checkbox"]:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .invoice-preview {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .employee-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.1rem;
            }

            .stat-card {
                margin-bottom: 15px;
            }
        }

        .badge-custom {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-car-wash me-2"></i>WashCenter Pro (MOCKED API)</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('newbill')">
                            <i class="fas fa-file-invoice me-1"></i>New Bill
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('reports')">
                            <i class="fas fa-chart-bar me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('employees')">
                            <i class="fas fa-users me-1"></i>Employees
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="dashboard" class="page-section active">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-chart-line me-2"></i>Dashboard</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-car"></i>
                        </div>
                        <h3 id="totalVehicles" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Total Vehicles Today</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3 id="totalEarnings" class="mb-1">₹...</h3>
                        <p class="text-muted mb-0">Total Earnings</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-spray-can"></i>
                        </div>
                        <h3 id="totalServices" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Services Done</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <h3 id="activeEmployees" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Active Employees</p>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Service-wise Count Today
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Count</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceStatsTable">
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clock me-2"></i>Recent Activities
                        </div>
                        <div class="card-body">
                            <div id="recentActivities">
                                <p class="text-muted">Loading activities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="newbill" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>Create New Bill</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-search me-2"></i>Vehicle Search
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <input type="text" id="vehicleNumber" class="form-control" placeholder="Enter Vehicle Number (e.g., KA01AB1234)" style="text-transform: uppercase;">
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="searchVehicle()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <i class="fas fa-user me-2"></i>Customer Information
                        </div>
                        <div class="card-body">
                            <form id="customerForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Customer Name</label>
                                        <input type="text" id="customerName" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Mobile Number</label>
                                        <input type="tel" id="mobileNumber" class="form-control" pattern="[0-9]{10}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Vehicle Number</label>
                                        <input type="text" id="vehicleNumberDisplay" class="form-control" readonly style="text-transform: uppercase;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Vehicle Type</label>
                                        <select id="vehicleType" class="form-select" required>
                                            <option value="">Select Type</option>
                                            <option value="Car">Car</option>
                                            <option value="SUV">SUV</option>
                                            <option value="Bike">Bike</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <i class="fas fa-list-check me-2"></i>Select Services
                        </div>
                        <div class="card-body">
                            <div id="servicesList">
                                <p class="text-muted">Loading services...</p>
                            </div>

                            <hr>
                            <h6 class="mb-3">Add Custom Service</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <input type="text" id="customServiceName" class="form-control" placeholder="Service Name">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" id="customServicePrice" class="form-control" placeholder="Price">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="addCustomService()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Bill Preview
                        </div>
                        <div class="card-body">
                            <div class="invoice-preview" id="invoicePreview">
                                <div class="text-center mb-4">
                                    <h4 class="mb-0">WashCenter Pro</h4>
                                    <p class="text-muted small">Vehicle Washing & Care</p>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <strong>Bill No:</strong> <span id="billNumber">...</span>
                                    </div>
                                    <div class="col-6 text-end">
                                        <strong>Date:</strong> <span id="billDate">...</span>
                                    </div>
                                </div>

                                <hr>

                                <div class="mb-3">
                                    <strong>Customer:</strong> <span id="previewCustomer">-</span><br>
                                    <strong>Mobile:</strong> <span id="previewMobile">-</span><br>
                                    <strong>Vehicle:</strong> <span id="previewVehicle">-</span>
                                </div>

                                <hr>

                                <h6>Services:</h6>
                                <div id="previewServices" class="mb-3">
                                    <p class="text-muted">No services selected</p>
                                </div>

                                <hr>

                                <div class="d-flex justify-content-between mb-3">
                                    <strong class="h5">Total Amount:</strong>
                                    <strong class="h5 text-primary">₹<span id="totalAmount">0</span></strong>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Payment Mode</label>
                                    <select id="paymentMode" class="form-select">
                                        <option value="Cash">Cash</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Card">Card</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Employee</label>
                                    <select id="employeeSelect" class="form-select">
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-lg" onclick="saveBill()">
                                        <i class="fas fa-save me-2"></i>Save Bill
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="printBill()">
                                        <i class="fas fa-print me-2"></i>Print / Download PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Reports</h2>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-filter me-2"></i>Filter Reports
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">From Date</label>
                            <input type="date" id="fromDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">To Date</label>
                            <input type="date" id="toDate" class="form-control">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="loadReports()">
                                <i class="fas fa-search me-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <i class="fas fa-table me-2"></i>Bills Summary
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Bill No</th>
                                    <th>Date</th>
                                    <th>Vehicle</th>
                                    <th>Customer</th>
                                    <th>Services</th>
                                    <th>Amount</th>
                                    <th>Employee</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Select date range and click Generate Report</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="employees" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-users me-2"></i>Employee Management</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user-plus me-2"></i>Add New Employee
                        </div>
                        <div class="card-body">
                            <form id="employeeForm">
                                <div class="mb-3">
                                    <label class="form-label">Employee Name</label>
                                    <input type="text" id="empName" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mobile Number</label>
                                    <input type="tel" id="empMobile" class="form-control" pattern="[0-9]{10}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Designation</label>
                                    <input type="text" id="empDesignation" class="form-control" placeholder="e.g., Washer, Manager" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select id="empStatus" class="form-select">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i>Save Employee
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list me-2"></i>Employee List
                        </div>
                        <div class="card-body">
                            <div id="employeesList">
                                <p class="text-muted">Loading employees...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script src="https://unpkg.com/msw@1.3.2/lib/umd/index.js"></script>

    <script>
        // --- 1. CONFIGURATION AND MOCK DATA (Initial State) ---

        const API_BASE_URL = '/api';
        let appData = {
            // CORRECTED: This ensures the initial services are correct.
            services: [
                { id: 1, name: 'Basic Wash', price: 200 },
                { id: 2, name: 'Premium Wash', price: 400 },
                { id: 3, name: 'Interior Cleaning', price: 300 },
                { id: 4, name: 'Wax Polish', price: 500 },
                { id: 5, name: 'Engine Wash', price: 250 }
            ],
            employees: [
                { id: 1, name: 'Rajesh Kumar', mobile: '9876543210', designation: 'Senior Washer', status: 'Active' },
                { id: 2, name: 'Amit Singh', mobile: '9876543211', designation: 'Washer', status: 'Active' }
            ],
            customers: [
                { name: 'John Doe', mobile: '9876543210', vehicleNumber: 'KA01AB1234', vehicleType: 'Car' }
            ],
            bills: [],
            nextBillNo: 1001
        };

        // --- 2. MOCK API HANDLERS (Simulating the Backend) ---

        const { rest, setupWorker } = window.msw;

        const handlers = [

            // Dashboard Stats
            rest.get(`${API_BASE_URL}/dashboard/stats`, (req, res, ctx) => {
                const totalVehicles = appData.bills.length;
                const totalEarnings = appData.bills.reduce((sum, bill) => sum + bill.totalAmount, 0);
                const totalServices = appData.bills.reduce((sum, bill) => sum + bill.services.length, 0);
                const activeEmployees = appData.employees.filter(e => e.status === 'Active').length;

                let serviceStats = {};
                appData.bills.forEach(bill => {
                    bill.services.forEach(service => {
                        if (!serviceStats[service.name]) {
                            serviceStats[service.name] = { count: 0, revenue: 0 };
                        }
                        serviceStats[service.name].count += 1;
                        serviceStats[service.name].revenue += service.price;
                    });
                });

                const recentActivities = appData.bills.slice(-5).reverse().map(bill => ({
                    time: new Date(bill.date).toLocaleTimeString(),
                    description: `Bill ${bill.billNo} created for ${bill.vehicleNumber}`
                }));

                return res(
                    ctx.delay(500),
                    ctx.status(200),
                    ctx.json({
                        totalVehicles,
                        totalEarnings,
                        totalServices,
                        activeEmployees,
                        serviceStats: Object.keys(serviceStats).map(name => ({ service: name, ...serviceStats[name] })),
                        recentActivities
                    })
                );
            }),


            // Services (GET /api/services)
            rest.get(`${API_BASE_URL}/services`, (req, res, ctx) => {
                // Ensure this returns the current state of services, including customs
                return res(
                    ctx.delay(300),
                    ctx.status(200),
                    ctx.json(appData.services)
                );
            }),

            // Add Custom Service (POST /api/services)
            rest.post(`${API_BASE_URL}/services`, async (req, res, ctx) => {
                const newService = await req.json();
                // Find next available ID (to avoid conflicts with original 1-5 IDs)
                const maxId = appData.services.reduce((max, s) => Math.max(max, s.id), 0);
                const id = maxId < 100 ? 100 + appData.services.length : maxId + 1;

                const serviceWithId = { ...newService, id, custom: true, price: parseInt(newService.price) };
                appData.services.push(serviceWithId);

                return res(
                    ctx.delay(200),
                    ctx.status(201),
                    ctx.json(serviceWithId)
                );
            }),

            // Customer Search (GET /api/customers?vehicleNumber=...)
            rest.get(`${API_BASE_URL}/customers`, (req, res, ctx) => {
                const vehicleNumber = req.url.searchParams.get('vehicleNumber')?.toUpperCase();
                const customer = appData.customers.find(c => c.vehicleNumber === vehicleNumber);

                if (customer) {
                    return res(
                        ctx.delay(300),
                        ctx.status(200),
                        ctx.json(customer)
                    );
                } else {
                    return res(
                        ctx.delay(300),
                        ctx.status(404),
                        ctx.json({ message: 'Customer not found' })
                    );
                }
            }),

            // Employees (GET /api/employees)
            rest.get(`${API_BASE_URL}/employees`, (req, res, ctx) => {
                return res(
                    ctx.delay(300),
                    ctx.status(200),
                    ctx.json(appData.employees)
                );
            }),

            // Add Employee (POST /api/employees)
            rest.post(`${API_BASE_URL}/employees`, async (req, res, ctx) => {
                const newEmployee = await req.json();
                const id = appData.employees.reduce((max, e) => Math.max(max, e.id), 0) + 1;
                const employeeWithId = { ...newEmployee, id: id };
                appData.employees.push(employeeWithId);

                return res(
                    ctx.delay(200),
                    ctx.status(201),
                    ctx.json(employeeWithId)
                );
            }),

            // Save Bill (POST /api/bills)
            rest.post(`${API_BASE_URL}/bills`, async (req, res, ctx) => {
                const billData = await req.json();
                const billNo = appData.nextBillNo++;
                const newBill = {
                    ...billData,
                    billNo: billNo,
                    date: new Date().toISOString()
                };
                appData.bills.push(newBill);

                // Also update customer list if it's a new customer
                const existingCustomer = appData.customers.find(c => c.vehicleNumber === billData.vehicleNumber);
                if (!existingCustomer) {
                    appData.customers.push({
                        name: billData.customerName,
                        mobile: billData.mobileNumber,
                        vehicleNumber: billData.vehicleNumber,
                        vehicleType: billData.vehicleType
                    });
                }

                return res(
                    ctx.delay(500),
                    ctx.status(201),
                    ctx.json({ billNo: billNo, message: 'Bill saved successfully' })
                );
            }),

            // Reports (GET /api/bills/report?fromDate=...&toDate=...)
            rest.get(`${API_BASE_URL}/bills/report`, (req, res, ctx) => {
                const fromDate = req.url.searchParams.get('fromDate');
                const toDate = req.url.searchParams.get('toDate');

                // Simple date filtering logic
                const filteredBills = appData.bills.filter(bill => {
                    const billDate = bill.date.substring(0, 10);
                    return billDate >= fromDate && billDate <= toDate;
                }).map(bill => {
                    const employee = appData.employees.find(e => e.id === bill.employeeId);
                    return {
                        billNo: bill.billNo,
                        date: bill.date.substring(0, 10),
                        vehicleNumber: bill.vehicleNumber,
                        customerName: bill.customerName,
                        servicesCount: bill.services.length,
                        amount: bill.totalAmount,
                        employeeName: employee ? employee.name : 'N/A'
                    };
                });

                return res(
                    ctx.delay(500),
                    ctx.status(200),
                    ctx.json(filteredBills)
                );
            }),
        ];

        // Start the Mock Service Worker
        const worker = setupWorker(...handlers);
        worker.start({ onUnhandledRequest: 'bypass' });

        // --- 3. FRONTEND LOGIC (Modified to use fetch() API calls) ---

        let localServicesCache = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup is now async due to API calls
            Promise.all([
                loadServices(),
                loadEmployees(),
                updateDashboard(),
            ]).then(() => {
                document.getElementById('billNumber').textContent = appData.nextBillNo;
                document.getElementById('billDate').textContent = new Date().toLocaleDateString();
                setDefaultDates();
            });

            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEmployee();
            });

            document.getElementById('customerForm').addEventListener('input', updateBillPreviewCustomer);
        });

        // Navigation and Utility functions (omitted for brevity, they are unchanged from previous version)

        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'newbill') {
                resetBillForm();
            } else if (pageId === 'employees') {
                loadEmployees();
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().substring(0, 10);
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
        }

        function resetBillForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('vehicleNumberDisplay').value = '';

            localServicesCache.forEach(service => {
                const checkbox = document.getElementById('service' + service.id);
                if (checkbox) checkbox.checked = false;
            });

            document.getElementById('customServiceName').value = '';
            document.getElementById('customServicePrice').value = '';

            document.getElementById('billNumber').textContent = appData.nextBillNo;
            document.getElementById('billDate').textContent = new Date().toLocaleDateString();

            document.getElementById('previewCustomer').textContent = '-';
            document.getElementById('previewMobile').textContent = '-';
            document.getElementById('previewVehicle').textContent = '-';
            updateBillPreview();
        }


        // --- API Integration Functions (Core logic remains the same, relying on fixed data) ---

        async function loadServices() {
            const container = document.getElementById('servicesList');
            container.innerHTML = '<p class="text-muted">Loading services...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/services`);
                localServicesCache = await response.json();

                container.innerHTML = '';
                localServicesCache.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'service-item';
                    div.innerHTML = `
                        <div class="form-check d-flex justify-content-between align-items-center">
                            <div>
                                <input class="form-check-input" type="checkbox" value="${service.id}"
                                    id="service${service.id}" onchange="updateBillPreview()">
                                <label class="form-check-label" for="service${service.id}">
                                    ${service.name}
                                </label>
                            </div>
                            <span class="badge bg-primary">₹${service.price}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading services:', error);
                container.innerHTML = '<p class="text-danger">Failed to load services. Check console.</p>';
            }
        }

        async function addCustomService() {
            const name = document.getElementById('customServiceName').value.trim();
            const price = document.getElementById('customServicePrice').value;

            if (!name || !price || isNaN(parseInt(price))) {
                alert('Please enter service name and a valid price');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price: parseInt(price) })
                });

                if (response.ok) {
                    await loadServices();
                    alert(`Service "${name}" added.`);
                    document.getElementById('customServiceName').value = '';
                    document.getElementById('customServicePrice').value = '';
                } else {
                    alert('Failed to add custom service.');
                }
            } catch (error) {
                console.error('Error adding custom service:', error);
                alert('Network error while adding service.');
            }
        }

        async function searchVehicle() {
            const vehicleNum = document.getElementById('vehicleNumber').value.toUpperCase().trim();

            if (!vehicleNum) {
                alert('Please enter vehicle number');
                return;
            }

            document.getElementById('vehicleNumberDisplay').value = vehicleNum;

            try {
                const response = await fetch(`${API_BASE_URL}/customers?vehicleNumber=${vehicleNum}`);

                if (response.ok) {
                    const customer = await response.json();

                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('mobileNumber').value = customer.mobile;
                    document.getElementById('vehicleType').value = customer.vehicleType;

                    alert('Customer found! Details auto-filled.');
                } else if (response.status === 404) {
                    document.getElementById('customerName').value = '';
                    document.getElementById('mobileNumber').value = '';
                    document.getElementById('vehicleType').value = '';

                    alert('New customer! Please fill in the details.');
                } else {
                     alert(`Error: ${response.statusText}`);
                }
                updateBillPreviewCustomer();
            } catch (error) {
                console.error("Error during vehicle search:", error);
                alert('An error occurred during search.');
            }
        }

        async function loadEmployees() {
            const select = document.getElementById('employeeSelect');
            const listContainer = document.getElementById('employeesList');

            select.innerHTML = '<option value="">Loading...</option>';
            listContainer.innerHTML = '<p class="text-muted">Loading employees...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/employees`);
                const employees = await response.json();
                appData.employees = employees;

                select.innerHTML = '<option value="">Select Employee</option>';
                listContainer.innerHTML = '';

                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.designation})`;
                    select.appendChild(option);

                    listContainer.innerHTML += `
                        <div class="employee-card d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${emp.name}</strong> - <span class="text-muted">${emp.designation}</span>
                                <br><small>Mobile: ${emp.mobile}</small>
                            </div>
                            <span class="badge badge-custom ${emp.status === 'Active' ? 'bg-success' : 'bg-secondary'}">${emp.status}</span>
                        </div>
                    `;
                });
                document.getElementById('activeEmployees').textContent = employees.filter(e => e.status === 'Active').length;

            } catch (error) {
                console.error("Error loading employees:", error);
                select.innerHTML = '<option value="">Error Loading</option>';
                listContainer.innerHTML = '<p class="text-danger">Failed to load employee data.</p>';
            }
        }

        async function saveEmployee() {
            const newEmployee = {
                name: document.getElementById('empName').value.trim(),
                mobile: document.getElementById('empMobile').value.trim(),
                designation: document.getElementById('empDesignation').value.trim(),
                status: document.getElementById('empStatus').value
            };

            if (!newEmployee.name || !newEmployee.mobile || !newEmployee.designation) {
                alert('Please fill in all employee details.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/employees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newEmployee)
                });

                if (response.ok) {
                    document.getElementById('employeeForm').reset();
                    await loadEmployees();
                    alert(`${newEmployee.name} added successfully.`);
                } else {
                    alert('Failed to save employee.');
                }
            } catch (error) {
                console.error("Error saving employee:", error);
                alert('Network error while saving employee.');
            }
        }

        async function saveBill() {
            const customerName = document.getElementById('customerName').value.trim();
            const mobile = document.getElementById('mobileNumber').value.trim();
            const vehicleNum = document.getElementById('vehicleNumberDisplay').value.trim();
            const vehicleType = document.getElementById('vehicleType').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const employeeId = document.getElementById('employeeSelect').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').textContent);

            if (!customerName || !mobile || !vehicleNum || !vehicleType || !employeeId || totalAmount === 0) {
                alert('Please fill in all customer details and select at least one service.');
                return;
            }

            let selectedServices = [];
            localServicesCache.forEach(service => {
                const checkbox = document.getElementById('service' + service.id);
                if (checkbox && checkbox.checked) {
                    selectedServices.push({ id: service.id, name: service.name, price: service.price });
                }
            });

            if (selectedServices.length === 0) {
                alert('Please select at least one service.');
                return;
            }

            const billData = {
                customerName,
                mobileNumber: mobile,
                vehicleNumber: vehicleNum,
                vehicleType,
                services: selectedServices,
                totalAmount,
                paymentMode,
                employeeId: parseInt(employeeId)
            };

            try {
                const response = await fetch(`${API_BASE_URL}/bills`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(billData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Bill ${result.billNo} saved successfully!`);
                    updateDashboard();
                    resetBillForm();
                } else {
                    alert(`Failed to save bill: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Error saving bill:", error);
                alert('A network error occurred while saving the bill.');
            }
        }

        async function loadReports() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const reportsTable = document.getElementById('reportsTable');

            if (!fromDate || !toDate) {
                alert('Please select both From Date and To Date.');
                return;
            }

            reportsTable.innerHTML = `<tr><td colspan="7" class="text-center text-info">Generating report...</td></tr>`;

            try {
                const response = await fetch(`${API_BASE_URL}/bills/report?fromDate=${fromDate}&toDate=${toDate}`);
                const bills = await response.json();

                if (bills.length === 0) {
                    reportsTable.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No bills found for the selected date range.</td></tr>`;
                    return;
                }

                reportsTable.innerHTML = '';
                bills.forEach(bill => {
                    reportsTable.innerHTML += `
                        <tr>
                            <td>${bill.billNo}</td>
                            <td>${bill.date}</td>
                            <td>${bill.vehicleNumber}</td>
                            <td>${bill.customerName}</td>
                            <td>${bill.servicesCount}</td>
                            <td>₹${bill.amount}</td>
                            <td>${bill.employeeName}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error("Error loading reports:", error);
                reportsTable.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Failed to load reports.</td></tr>`;
            }
        }

        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
                const data = await response.json();

                document.getElementById('totalVehicles').textContent = data.totalVehicles;
                document.getElementById('totalEarnings').textContent = `₹${data.totalEarnings.toLocaleString('en-IN')}`;
                document.getElementById('totalServices').textContent = data.totalServices;
                document.getElementById('activeEmployees').textContent = data.activeEmployees;

                // Service Stats Table
                const statsTable = document.getElementById('serviceStatsTable');
                statsTable.innerHTML = '';
                if (data.serviceStats.length > 0) {
                    data.serviceStats.forEach(stat => {
                        statsTable.innerHTML += `
                            <tr>
                                <td>${stat.service}</td>
                                <td>${stat.count}</td>
                                <td>₹${stat.revenue}</td>
                            </tr>
                        `;
                    });
                } else {
                    statsTable.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>`;
                }

                // Recent Activities
                const activitiesDiv = document.getElementById('recentActivities');
                activitiesDiv.innerHTML = '';
                if (data.recentActivities.length > 0) {
                    data.recentActivities.forEach(activity => {
                        activitiesDiv.innerHTML += `<p class="mb-1"><strong>${activity.time}:</strong> ${activity.description}</p>`;
                    });
                } else {
                     activitiesDiv.innerHTML = '<p class="text-muted">No recent activities</p>';
                }


            } catch (error) {
                console.error('Error updating dashboard:', error);
                document.querySelectorAll('.stat-card h3').forEach(h3 => h3.textContent = 'Err');
                document.getElementById('serviceStatsTable').innerHTML = `<tr><td colspan="3" class="text-center text-danger">Failed to load stats.</td></tr>`;
            }
        }

        function updateBillPreviewCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const mobile = document.getElementById('mobileNumber').value.trim();
            const vehicleNum = document.getElementById('vehicleNumberDisplay').value.trim();
            const vehicleType = document.getElementById('vehicleType').value;

            document.getElementById('previewCustomer').textContent = name || '-';
            document.getElementById('previewMobile').textContent = mobile || '-';
            document.getElementById('previewVehicle').textContent = (vehicleNum && vehicleType) ? `${vehicleNum} (${vehicleType})` : vehicleNum || '-';
        }

        function updateBillPreview() {
            updateBillPreviewCustomer();

            let selectedServices = [];
            let total = 0;

            localServicesCache.forEach(service => {
                const checkbox = document.getElementById('service' + service.id);
                if (checkbox && checkbox.checked) {
                    selectedServices.push(service);
                    total += service.price;
                }
            });

            const servicesDiv = document.getElementById('previewServices');
            if (selectedServices.length > 0) {
                servicesDiv.innerHTML = selectedServices.map(s => `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${s.name}</span>
                        <span>₹${s.price}</span>
                    </div>
                `).join('');
            } else {
                servicesDiv.innerHTML = '<p class="text-muted">No services selected</p>';
            }

            document.getElementById('totalAmount').textContent = total;
        }

        function printBill() {
            alert("Print/PDF functionality would be implemented here.");
        }
    </script>
</body>
</html>