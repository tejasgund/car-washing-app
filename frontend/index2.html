<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Washing Center - Billing Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --dark-bg: #1e293b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f5f9;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }

        .service-item {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .service-item:hover {
            border-color: var(--primary-color);
            background-color: #f8fafc;
        }

        .service-item input[type="checkbox"]:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .invoice-preview {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .employee-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.1rem;
            }

            .stat-card {
                margin-bottom: 15px;
            }
        }

        .badge-custom {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-car-wash me-2"></i>WashCenter Pro</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('dashboard', event)">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('newbill', event)">
                            <i class="fas fa-file-invoice me-1"></i>New Bill
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('reports', event)">
                            <i class="fas fa-chart-bar me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('employees', event)">
                            <i class="fas fa-users me-1"></i>Employees
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="dashboard" class="page-section active">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-chart-line me-2"></i>Dashboard</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-car"></i>
                        </div>
                        <h3 id="totalVehicles" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Total Vehicles Today</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3 id="totalEarnings" class="mb-1">â‚¹...</h3>
                        <p class="text-muted mb-0">Total Earnings</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-spray-can"></i>
                        </div>
                        <h3 id="totalServices" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Services Done</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <h3 id="activeEmployees" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Active Employees</p>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Service-wise Count Today
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Count</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceStatsTable">
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clock me-2"></i>Recent Activities
                        </div>
                        <div class="card-body">
                            <div id="recentActivities">
                                <p class="text-muted">Loading activities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="newbill" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>Create New Bill</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-search me-2"></i>Vehicle Search
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <input type="text" id="vehicleNumber" class="form-control" placeholder="Enter Vehicle Number (e.g., KA01AB1234)" style="text-transform: uppercase;">
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="searchVehicle()" id="searchVehicleBtn">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <i class="fas fa-user me-2"></i>Customer Information
                        </div>
                        <div class="card-body">
                            <form id="customerForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Customer Name</label>
                                        <input type="text" id="customerName" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Mobile Number</label>
                                        <input type="tel" id="mobileNumber" class="form-control" pattern="[0-9]{10}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Vehicle Number</label>
                                        <input type="text" id="vehicleNumberDisplay" class="form-control" readonly style="text-transform: uppercase;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Vehicle Type</label>
                                        <select id="vehicleType" class="form-select" required>
                                            <option value="">Select Type</option>
                                            <option value="Car">Car</option>
                                            <option value="SUV">SUV</option>
                                            <option value="Bike">Bike</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <i class="fas fa-list-check me-2"></i>Select Services
                        </div>
                        <div class="card-body">
                            <div id="servicesList">
                                <p class="text-muted">Loading services...</p>
                            </div>

                            <hr>
                            <h6 class="mb-3">Add Custom Service</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <input type="text" id="customServiceName" class="form-control" placeholder="Service Name">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" id="customServicePrice" class="form-control" placeholder="Price">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="addCustomService()" id="addServiceBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Bill Preview
                        </div>
                        <div class="card-body">
                            <div class="invoice-preview" id="invoicePreview">
                                <div class="text-center mb-4">
                                    <h4 class="mb-0">WashCenter Pro</h4>
                                    <p class="text-muted small">Vehicle Washing & Care</p>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <strong>Bill No:</strong> <span id="billNumber">...</span>
                                    </div>
                                    <div class="col-6 text-end">
                                        <strong>Date:</strong> <span id="billDate">...</span>
                                    </div>
                                </div>

                                <hr>

                                <div class="mb-3">
                                    <strong>Customer:</strong> <span id="previewCustomer">-</span><br>
                                    <strong>Mobile:</strong> <span id="previewMobile">-</span><br>
                                    <strong>Vehicle:</strong> <span id="previewVehicle">-</span>
                                </div>

                                <hr>

                                <h6>Services:</h6>
                                <div id="previewServices" class="mb-3">
                                    <p class="text-muted">No services selected</p>
                                </div>

                                <hr>

                                <div class="d-flex justify-content-between mb-3">
                                    <strong class="h5">Total Amount:</strong>
                                    <strong class="h5 text-primary">â‚¹<span id="totalAmount">0</span></strong>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Payment Mode</label>
                                    <select id="paymentMode" class="form-select">
                                        <option value="Cash">Cash</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Card">Card</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Employee</label>
                                    <select id="employeeSelect" class="form-select">
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-lg" onclick="saveBill()" id="saveBillBtn">
                                        <i class="fas fa-save me-2"></i>Save Bill
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="printBill()">
                                        <i class="fas fa-print me-2"></i>Print / Download PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Reports</h2>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-filter me-2"></i>Filter Reports
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">From Date</label>
                            <input type="date" id="fromDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">To Date</label>
                            <input type="date" id="toDate" class="form-control">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="loadReports()" id="generateReportBtn">
                                <i class="fas fa-search me-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <i class="fas fa-table me-2"></i>Bills Summary
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Bill No</th>
                                    <th>Date</th>
                                    <th>Vehicle</th>
                                    <th>Customer</th>
                                    <th>Services</th>
                                    <th>Amount</th>
                                    <th>Employee</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Select date range and click Generate Report</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="employees" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-users me-2"></i>Employee Management</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user-plus me-2"></i>Add New Employee
                        </div>
                        <div class="card-body">
                            <form id="employeeForm">
                                <div class="mb-3">
                                    <label class="form-label">Employee Name</label>
                                    <input type="text" id="empName" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mobile Number</label>
                                    <input type="tel" id="empMobile" class="form-control" pattern="[0-9]{10}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Designation</label>
                                    <input type="text" id="empDesignation" class="form-control" placeholder="e.g., Washer, Manager" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select id="empStatus" class="form-select">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="saveEmployeeBtn">
                                    <i class="fas fa-save me-2"></i>Save Employee
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list me-2"></i>Employee List
                        </div>
                        <div class="card-body">
                            <div id="employeesList">
                                <p class="text-muted">Loading employees...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        // NOTE: This URL is external. Since we can't guarantee a live server,
        // the remaining functions will use simulated fetch calls for a functional demo.
        const API_BASE_URL = 'http://15.206.151.116:8080/api';

        // --- GLOBAL STATE/CACHE ---
        let localServicesCache = [];
        let localEmployeesCache = [];
        let localBillsCache = []; // To store mock bills
        let nextBillNo = 1001;

        // --- FRONTEND LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup
            // Use a timeout to simulate asynchronous loading of services and employees
            setTimeout(async () => {
                await loadServices();
                await loadEmployees();
                await updateDashboard();
                document.getElementById('billNumber').textContent = nextBillNo;
                document.getElementById('billDate').textContent = new Date().toLocaleDateString();
                setDefaultDates();
            }, 100);

            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEmployee();
            });

            // Set up event listeners for bill preview updates
            document.getElementById('customerForm').addEventListener('input', updateBillPreviewCustomer);
            document.getElementById('vehicleType').addEventListener('change', updateBillPreviewCustomer);
        });

        // Navigation
        function showPage(pageId, event) {
            if (event) event.preventDefault();
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event) event.target.classList.add('active'); // Add active class to clicked link

            if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'newbill') {
                resetBillForm();
            } else if (pageId === 'employees') {
                loadEmployees();
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().substring(0, 10);
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
        }

        function resetBillForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('vehicleNumberDisplay').value = '';

            // Uncheck all service checkboxes
            localServicesCache.forEach(service => {
                const checkbox = document.getElementById('service' + service.id);
                if (checkbox) checkbox.checked = false;
            });

            document.getElementById('customServiceName').value = '';
            document.getElementById('customServicePrice').value = '';

            // Update bill number and date
            document.getElementById('billNumber').textContent = nextBillNo;
            document.getElementById('billDate').textContent = new Date().toLocaleDateString();
            document.getElementById('paymentMode').value = 'Cash'; // Reset payment mode

            // Reset preview
            document.getElementById('previewCustomer').textContent = '-';
            document.getElementById('previewMobile').textContent = '-';
            document.getElementById('previewVehicle').textContent = '-';
            updateBillPreview();
        }

        // Utility function to show loading state
        function setLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.setAttribute('data-original-text', button.innerHTML);
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
            } else {
                button.disabled = false;
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                }
            }
        }

        // --- API Integration Functions (Simulated) ---

        // Load Services (GET /api/services)
        async function loadServices() {
            const container = document.getElementById('servicesList');
            container.innerHTML = '<p class="text-muted">Loading services...</p>';
            try {
                // SIMULATED API CALL: Replace with actual fetch if a live API is available
                await new Promise(resolve => setTimeout(resolve, 300));

                // Mock Services Data
                const mockServices = [
                    { id: 1, name: "Basic Exterior Wash", price: 300 },
                    { id: 2, name: "Full Wash & Vacuum", price: 650 },
                    { id: 3, name: "Interior Deep Cleaning", price: 1200 },
                    { id: 4, name: "Waxing & Polishing", price: 1500 },
                ];

                localServicesCache = mockServices;

                container.innerHTML = '';
                localServicesCache.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'service-item';
                    div.innerHTML = `
                        <div class="form-check d-flex justify-content-between align-items-center">
                            <div>
                                <input class="form-check-input" type="checkbox" value="${service.id}"
                                    id="service${service.id}" data-price="${service.price}" data-name="${service.name}" onchange="updateBillPreview()">
                                <label class="form-check-label" for="service${service.id}">
                                    ${service.name}
                                </label>
                            </div>
                            <span class="badge bg-primary">â‚¹${service.price}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading services:', error);
                container.innerHTML = '<p class="text-danger">Failed to load services. (Simulated)</p>';
            }
        }

        // Add Custom Service (POST /api/services) - Function implemented as a local add for demo
        async function addCustomService() {
            const name = document.getElementById('customServiceName').value.trim();
            const price = parseInt(document.getElementById('customServicePrice').value);
            const button = document.getElementById('addServiceBtn');

            if (!name || isNaN(price) || price <= 0) {
                alert('Please enter a valid service name and price');
                return;
            }

            setLoading(button, true);

            try {
                // SIMULATED API CALL: Locally add the service and update UI
                await new Promise(resolve => setTimeout(resolve, 500));

                const newId = localServicesCache.length + 100; // Unique mock ID
                const newService = { id: newId, name, price };
                localServicesCache.push(newService);

                await loadServices(); // Reload services to show the new one

                // Select the newly added service automatically
                const newCheckbox = document.getElementById('service' + newId);
                if (newCheckbox) newCheckbox.checked = true;

                updateBillPreview();
                alert(`Service "${name}" added and selected.`);
                document.getElementById('customServiceName').value = '';
                document.getElementById('customServicePrice').value = '';
            } catch (error) {
                console.error('Error adding custom service:', error);
                alert('Failed to add custom service. (Simulated)');
            } finally {
                setLoading(button, false);
            }
        }

        // Vehicle Search (GET /api/customers?vehicleNumber=...)
        async function searchVehicle() {
            const vehicleNum = document.getElementById('vehicleNumber').value.toUpperCase().trim();
            const button = document.getElementById('searchVehicleBtn');

            if (!vehicleNum) {
                alert('Please enter vehicle number');
                return;
            }

            document.getElementById('vehicleNumberDisplay').value = vehicleNum;
            setLoading(button, true);

            try {
                // SIMULATED API CALL: Mock customer data lookup
                await new Promise(resolve => setTimeout(resolve, 800));

                let customerData = null;
                if (vehicleNum === 'KA01AB1234') {
                    customerData = { name: "Anil Kumar", mobile: "9876543210", vehicleType: "SUV" };
                } else if (vehicleNum === 'DL05ZZ9999') {
                    customerData = { name: "Priya Sharma", mobile: "9988776655", vehicleType: "Bike" };
                }

                if (customerData) {
                    document.getElementById('customerName').value = customerData.name;
                    document.getElementById('mobileNumber').value = customerData.mobile;
                    document.getElementById('vehicleType').value = customerData.vehicleType;
                    alert('Customer found! Details pre-filled.');
                } else {
                    document.getElementById('customerName').value = '';
                    document.getElementById('mobileNumber').value = '';
                    document.getElementById('vehicleType').value = 'Car'; // Default type
                    alert('New customer. Please fill in details.');
                }
                updateBillPreviewCustomer(); // Update preview with new data

            } catch (error) {
                console.error('Error searching vehicle:', error);
                alert('Failed to search vehicle. (Simulated)');
            } finally {
                setLoading(button, false);
            }
        }

        // Update Bill Preview - Customer Info
        function updateBillPreviewCustomer() {
            document.getElementById('previewCustomer').textContent = document.getElementById('customerName').value || '-';
            document.getElementById('previewMobile').textContent = document.getElementById('mobileNumber').value || '-';
            const vehicleNum = document.getElementById('vehicleNumberDisplay').value;
            const vehicleType = document.getElementById('vehicleType').value;
            document.getElementById('previewVehicle').textContent = (vehicleNum ? vehicleNum : '-') + (vehicleType ? ` (${vehicleType})` : '');
        }

        // Update Bill Preview - Services and Total
        function updateBillPreview() {
            let totalAmount = 0;
            const previewServicesDiv = document.getElementById('previewServices');
            previewServicesDiv.innerHTML = '';
            const selectedServices = [];

            // Get all service checkboxes
            const checkboxes = document.querySelectorAll('#servicesList input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const price = parseFloat(checkbox.getAttribute('data-price'));
                    const name = checkbox.getAttribute('data-name');
                    totalAmount += price;
                    selectedServices.push({ name, price });
                }
            });

            if (selectedServices.length === 0) {
                previewServicesDiv.innerHTML = '<p class="text-muted">No services selected</p>';
            } else {
                const ul = document.createElement('ul');
                ul.className = 'list-unstyled small';
                selectedServices.forEach(service => {
                    const li = document.createElement('li');
                    li.className = 'd-flex justify-content-between';
                    li.innerHTML = `<span><i class="fas fa-check-circle text-success me-1"></i>${service.name}</span> <span>â‚¹${service.price}</span>`;
                    ul.appendChild(li);
                });
                previewServicesDiv.appendChild(ul);
            }

            document.getElementById('totalAmount').textContent = totalAmount.toFixed(0);
        }

        // Save Bill (POST /api/bills)
        async function saveBill() {
            const customerName = document.getElementById('customerName').value.trim();
            const mobileNumber = document.getElementById('mobileNumber').value.trim();
            const vehicleNumber = document.getElementById('vehicleNumberDisplay').value.trim();
            const vehicleType = document.getElementById('vehicleType').value;
            const employeeId = document.getElementById('employeeSelect').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').textContent);

            if (!customerName || !mobileNumber || !vehicleNumber || !vehicleType || !employeeId || totalAmount === 0) {
                alert('Please fill all customer and vehicle details, select an employee, and choose at least one service.');
                return;
            }

            const selectedServices = [];
            document.querySelectorAll('#servicesList input[type="checkbox"]:checked').forEach(checkbox => {
                const service = localServicesCache.find(s => s.id == checkbox.value);
                if (service) selectedServices.push(service);
            });

            if (selectedServices.length === 0) {
                alert('Please select at least one service.');
                return;
            }

            const employeeName = localEmployeesCache.find(e => e.id == employeeId)?.name || 'N/A';
            const billData = {
                billNo: nextBillNo,
                date: new Date().toISOString().substring(0, 10),
                customer: customerName,
                mobile: mobileNumber,
                vehicle: vehicleNumber,
                vehicleType: vehicleType,
                services: selectedServices,
                amount: totalAmount,
                employeeId: parseInt(employeeId),
                employeeName: employeeName,
                paymentMode: document.getElementById('paymentMode').value,
            };

            const button = document.getElementById('saveBillBtn');
            setLoading(button, true);

            try {
                // SIMULATED API CALL: Save bill to local cache
                await new Promise(resolve => setTimeout(resolve, 1000));

                localBillsCache.unshift(billData); // Add to start of the list
                nextBillNo++; // Increment bill number
                await updateDashboard();

                alert(`Bill No. ${billData.billNo} saved successfully! Total: â‚¹${billData.amount}`);
                resetBillForm(); // Clear form and update bill number/date

            } catch (error) {
                console.error('Error saving bill:', error);
                alert('Failed to save bill. (Simulated)');
            } finally {
                setLoading(button, false);
            }
        }

        // Load Employees (GET /api/employees)
        async function loadEmployees() {
            const listContainer = document.getElementById('employeesList');
            const selectContainer = document.getElementById('employeeSelect');
            listContainer.innerHTML = '<p class="text-muted">Loading employees...</p>';
            selectContainer.innerHTML = '<option value="">Select Employee</option>';

            try {
                // SIMULATED API CALL: Mock Employee Data
                await new Promise(resolve => setTimeout(resolve, 300));

                const mockEmployees = [
                    { id: 1, name: "Ramesh Singh", mobile: "9000111222", designation: "Manager", status: "Active" },
                    { id: 2, name: "Sunil Verma", mobile: "9000333444", designation: "Washer", status: "Active" },
                    { id: 3, name: "Pooja Devi", mobile: "9000555666", designation: "Cashier", status: "Active" },
                ];
                localEmployeesCache = mockEmployees;

                listContainer.innerHTML = '';
                mockEmployees.forEach(emp => {
                    const statusClass = emp.status === 'Active' ? 'bg-success' : 'bg-danger';
                    listContainer.innerHTML += `
                        <div class="employee-card d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${emp.name}</strong> <span class="badge ${statusClass} bg-opacity-10 text-${statusClass.split('-')[1]}">${emp.status}</span><br>
                                <small class="text-muted">${emp.designation} - ${emp.mobile}</small>
                            </div>
                            </div>
                    `;
                    selectContainer.innerHTML += `<option value="${emp.id}">${emp.name} (${emp.designation})</option>`;
                });

                document.getElementById('activeEmployees').textContent = mockEmployees.filter(e => e.status === 'Active').length;

            } catch (error) {
                console.error('Error loading employees:', error);
                listContainer.innerHTML = '<p class="text-danger">Failed to load employees. (Simulated)</p>';
            }
        }

        // Save Employee (POST /api/employees)
        async function saveEmployee() {
            const name = document.getElementById('empName').value.trim();
            const mobile = document.getElementById('empMobile').value.trim();
            const designation = document.getElementById('empDesignation').value.trim();
            const status = document.getElementById('empStatus').value;
            const button = document.getElementById('saveEmployeeBtn');

            if (!name || !mobile || !designation) {
                alert('All fields are required.');
                return;
            }

            setLoading(button, true);

            try {
                // SIMULATED API CALL: Locally add the employee
                await new Promise(resolve => setTimeout(resolve, 800));

                const newId = localEmployeesCache.length + 100;
                const newEmployee = { id: newId, name, mobile, designation, status };
                localEmployeesCache.push(newEmployee);

                await loadEmployees();
                document.getElementById('employeeForm').reset();
                alert(`Employee "${name}" added successfully.`);

            } catch (error) {
                console.error('Error saving employee:', error);
                alert('Failed to save employee. (Simulated)');
            } finally {
                setLoading(button, false);
            }
        }

        // Update Dashboard Stats
        async function updateDashboard() {
            // Get today's bills
            const today = new Date().toISOString().substring(0, 10);
            const todayBills = localBillsCache.filter(bill => bill.date === today);

            const totalVehicles = todayBills.length;
            const totalEarnings = todayBills.reduce((sum, bill) => sum + bill.amount, 0);
            let totalServicesCount = 0;
            const serviceStats = {};

            todayBills.forEach(bill => {
                bill.services.forEach(service => {
                    totalServicesCount++;
                    if (!serviceStats[service.name]) {
                        serviceStats[service.name] = { count: 0, revenue: 0 };
                    }
                    serviceStats[service.name].count++;
                    serviceStats[service.name].revenue += service.price;
                });
            });

            // Update DOM
            document.getElementById('totalVehicles').textContent = totalVehicles;
            document.getElementById('totalEarnings').textContent = `â‚¹${totalEarnings.toFixed(0)}`;
            document.getElementById('totalServices').textContent = totalServicesCount;
            // activeEmployees is updated in loadEmployees

            // Update Service Stats Table
            const serviceTableBody = document.getElementById('serviceStatsTable');
            serviceTableBody.innerHTML = '';
            const sortedServices = Object.entries(serviceStats).sort(([, a], [, b]) => b.revenue - a.revenue);

            if (sortedServices.length === 0) {
                 serviceTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No services recorded today.</td></tr>';
            } else {
                sortedServices.forEach(([name, stats]) => {
                    serviceTableBody.innerHTML += `
                        <tr>
                            <td>${name}</td>
                            <td><span class="badge bg-primary">${stats.count}</span></td>
                            <td>â‚¹${stats.revenue.toFixed(0)}</td>
                        </tr>
                    `;
                });
            }

            // Update Recent Activities
            const recentActivitiesDiv = document.getElementById('recentActivities');
            recentActivitiesDiv.innerHTML = '';

            if (todayBills.length === 0) {
                recentActivitiesDiv.innerHTML = '<p class="text-muted">No activities today.</p>';
            } else {
                todayBills.slice(0, 5).forEach(bill => {
                    const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    recentActivitiesDiv.innerHTML += `
                        <p class="mb-2">
                            <i class="fas fa-receipt text-primary me-1"></i>
                            <strong>Bill #${bill.billNo}</strong> for ${bill.vehicle} (${bill.customer}) - â‚¹${bill.amount}
                            <span class="float-end text-muted small">${time}</span>
                        </p>
                    `;
                });
            }
        }

        // Load Reports
        async function loadReports() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const tableBody = document.getElementById('reportsTable');
            const button = document.getElementById('generateReportBtn');

            if (!fromDate || !toDate) {
                alert('Please select both From and To dates.');
                return;
            }

            setLoading(button, true);

            try {
                // SIMULATED FILTERING
                await new Promise(resolve => setTimeout(resolve, 800));

                const filteredBills = localBillsCache.filter(bill => {
                    // Simple date string comparison works for YYYY-MM-DD format
                    return bill.date >= fromDate && bill.date <= toDate;
                });

                tableBody.innerHTML = '';
                if (filteredBills.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No bills found for this date range.</td></tr>';
                } else {
                    filteredBills.forEach(bill => {
                        const servicesList = bill.services.map(s => s.name).join(', ');
                        tableBody.innerHTML += `
                            <tr>
                                <td><span class="badge bg-primary">${bill.billNo}</span></td>
                                <td>${bill.date}</td>
                                <td>${bill.vehicle}</td>
                                <td>${bill.customer}</td>
                                <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${servicesList}</td>
                                <td><strong>â‚¹${bill.amount.toFixed(0)}</strong></td>
                                <td>${bill.employeeName}</td>
                            </tr>
                        `;
                    });
                }

            } catch (error) {
                console.error('Error loading reports:', error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load reports. (Simulated)</td></tr>';
            } finally {
                setLoading(button, false);
            }
        }

        // Print/Download Bill
        function printBill() {
            const printContent = document.getElementById('invoicePreview').innerHTML;
            const originalContent = document.body.innerHTML;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Bill Printout</title>');
            // Include essential styles for print
            printWindow.document.write('<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('<style>body{ font-family: sans-serif; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container-fluid">' + printContent + '</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            // Wait for styles to load then print
            printWindow.onload = function() {
                printWindow.print();
                // Close the window after a short delay (for print preview to finish)
                setTimeout(() => printWindow.close(), 500);
            };
        }

    </script>
</body>
</html>