<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Washing Center - Billing Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --dark-bg: #1e293b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f5f9;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }

        .service-item {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .service-item:hover {
            border-color: var(--primary-color);
            background-color: #f8fafc;
        }

        .service-item input[type="checkbox"]:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .invoice-preview {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .employee-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.1rem;
            }

            .stat-card {
                margin-bottom: 15px;
            }
        }

        .badge-custom {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-car-wash me-2"></i>WashCenter Pro</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('newbill')">
                            <i class="fas fa-file-invoice me-1"></i>New Bill
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('reports')">
                            <i class="fas fa-chart-bar me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('employees')">
                            <i class="fas fa-users me-1"></i>Employees
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="dashboard" class="page-section active">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-chart-line me-2"></i>Dashboard</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-car"></i>
                        </div>
                        <h3 id="totalVehicles" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Total Vehicles Today</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3 id="totalEarnings" class="mb-1">â‚¹...</h3>
                        <p class="text-muted mb-0">Total Earnings</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-spray-can"></i>
                        </div>
                        <h3 id="totalServices" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Services Done</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <h3 id="activeEmployees" class="mb-1">...</h3>
                        <p class="text-muted mb-0">Active Employees</p>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Service-wise Count Today
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Count</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceStatsTable">
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-clock me-2"></i>Recent Activities
                        </div>
                        <div class="card-body">
                            <div id="recentActivities">
                                <p class="text-muted">Loading activities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="newbill" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>Create New Bill</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-search me-2"></i>Vehicle Search
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <input type="text" id="vehicleNumber" class="form-control" placeholder="Enter Vehicle Number (e.g., KA01AB1234)" style="text-transform: uppercase;">
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="searchVehicle()" id="searchVehicleBtn">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <i class="fas fa-user me-2"></i>Customer Information
                        </div>
                        <div class="card-body">
                            <form id="customerForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Customer Name</label>
                                        <input type="text" id="customerName" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Mobile Number</label>
                                        <input type="tel" id="mobileNumber" class="form-control" pattern="[0-9]{10}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Vehicle Number</label>
                                        <input type="text" id="vehicleNumberDisplay" class="form-control" readonly style="text-transform: uppercase;">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Vehicle Type</label>
                                        <select id="vehicleType" class="form-select" required>
                                            <option value="">Select Type</option>
                                            <option value="Car">Car</option>
                                            <option value="SUV">SUV</option>
                                            <option value="Bike">Bike</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <i class="fas fa-list-check me-2"></i>Select Services
                        </div>
                        <div class="card-body">
                            <div id="servicesList">
                                <p class="text-muted">Loading services...</p>
                            </div>

                            <hr>
                            <h6 class="mb-3">Add Custom Service</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <input type="text" id="customServiceName" class="form-control" placeholder="Service Name">
                                </div>
                                <div class="col-md-4">
                                    <input type="number" id="customServicePrice" class="form-control" placeholder="Price">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-success w-100" onclick="addCustomService()" id="addServiceBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Bill Preview
                        </div>
                        <div class="card-body">
                            <div class="invoice-preview" id="invoicePreview">
                                <div class="text-center mb-4">
                                    <h4 class="mb-0">WashCenter Pro</h4>
                                    <p class="text-muted small">Vehicle Washing & Care</p>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-6">
                                        <strong>Bill No:</strong> <span id="billNumber">...</span>
                                    </div>
                                    <div class="col-6 text-end">
                                        <strong>Date:</strong> <span id="billDate">...</span>
                                    </div>
                                </div>

                                <hr>

                                <div class="mb-3">
                                    <strong>Customer:</strong> <span id="previewCustomer">-</span><br>
                                    <strong>Mobile:</strong> <span id="previewMobile">-</span><br>
                                    <strong>Vehicle:</strong> <span id="previewVehicle">-</span>
                                </div>

                                <hr>

                                <h6>Services:</h6>
                                <div id="previewServices" class="mb-3">
                                    <p class="text-muted">No services selected</p>
                                </div>

                                <hr>

                                <div class="d-flex justify-content-between mb-3">
                                    <strong class="h5">Total Amount:</strong>
                                    <strong class="h5 text-primary">â‚¹<span id="totalAmount">0</span></strong>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Payment Mode</label>
                                    <select id="paymentMode" class="form-select">
                                        <option value="Cash">Cash</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Card">Card</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Employee</label>
                                    <select id="employeeSelect" class="form-select">
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-lg" onclick="saveBill()" id="saveBillBtn">
                                        <i class="fas fa-save me-2"></i>Save Bill
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="printBill()">
                                        <i class="fas fa-print me-2"></i>Print / Download PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Reports</h2>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-filter me-2"></i>Filter Reports
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">From Date</label>
                            <input type="date" id="fromDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">To Date</label>
                            <input type="date" id="toDate" class="form-control">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="loadReports()" id="generateReportBtn">
                                <i class="fas fa-search me-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <i class="fas fa-table me-2"></i>Bills Summary
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Bill No</th>
                                    <th>Date</th>
                                    <th>Vehicle</th>
                                    <th>Customer</th>
                                    <th>Services</th>
                                    <th>Amount</th>
                                    <th>Employee</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Select date range and click Generate Report</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="employees" class="page-section">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4"><i class="fas fa-users me-2"></i>Employee Management</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user-plus me-2"></i>Add New Employee
                        </div>
                        <div class="card-body">
                            <form id="employeeForm">
                                <div class="mb-3">
                                    <label class="form-label">Employee Name</label>
                                    <input type="text" id="empName" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mobile Number</label>
                                    <input type="tel" id="empMobile" class="form-control" pattern="[0-9]{10}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Designation</label>
                                    <input type="text" id="empDesignation" class="form-control" placeholder="e.g., Washer, Manager" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select id="empStatus" class="form-select">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="saveEmployeeBtn">
                                    <i class="fas fa-save me-2"></i>Save Employee
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list me-2"></i>Employee List
                        </div>
                        <div class="card-body">
                            <div id="employeesList">
                                <p class="text-muted">Loading employees...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        // NOTE: I'm using the URL from your prompt for the customer search below.
        const API_BASE_URL = 'http://15.206.90.104:8080/api'; // Used for services/employees/bills
        const CUSTOMER_SEARCH_URL = 'http://15.206.90.104/api/customers'; // Used for customer search

        // --- FRONTEND LOGIC ---
        let localServicesCache = [];
        let nextBillNo = 1001;

        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup
            Promise.all([
                loadServices(),
                loadEmployees(),
                updateDashboard(),
            ]).then(() => {
                document.getElementById('billNumber').textContent = nextBillNo;
                document.getElementById('billDate').textContent = new Date().toLocaleDateString();
                setDefaultDates();
            });

            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEmployee();
            });

            // Set up event listeners for bill preview updates
            document.getElementById('customerForm').addEventListener('input', updateBillPreviewCustomer);
        });

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'newbill') {
                resetBillForm();
            } else if (pageId === 'employees') {
                loadEmployees();
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().substring(0, 10);
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
        }

        function resetBillForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('vehicleNumberDisplay').value = '';

            // Uncheck all service checkboxes
            localServicesCache.forEach(service => {
                const checkbox = document.getElementById('service' + service.id);
                if (checkbox) checkbox.checked = false;
            });

            document.getElementById('customServiceName').value = '';
            document.getElementById('customServicePrice').value = '';

            document.getElementById('billNumber').textContent = nextBillNo;
            document.getElementById('billDate').textContent = new Date().toLocaleDateString();

            // Reset preview
            document.getElementById('previewCustomer').textContent = '-';
            document.getElementById('previewMobile').textContent = '-';
            document.getElementById('previewVehicle').textContent = '-';
            updateBillPreview();
        }

        // Utility function to show loading state
        function setLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                if (!button.getAttribute('data-original-text')) {
                    button.setAttribute('data-original-text', button.innerHTML);
                }
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
            } else {
                button.disabled = false;
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                }
            }
        }

        // --- API Integration Functions ---

        // Load Services (GET /api/services) - Placeholder for brevity, assuming this works
        async function loadServices() {
            const container = document.getElementById('servicesList');
            // Mock data for demonstration if API is unavailable, replace with actual fetch:
            localServicesCache = [
                { id: 1, name: "Basic Wash", price: 150 },
                { id: 2, name: "Interior & Exterior", price: 300 },
                { id: 3, name: "Full Detailing", price: 1500 }
            ];
            container.innerHTML = '';
            localServicesCache.forEach(service => {
                const div = document.createElement('div');
                div.className = 'service-item';
                div.innerHTML = `
                    <div class="form-check d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input" type="checkbox" value="${service.id}"
                                id="service${service.id}" onchange="updateBillPreview()">
                            <label class="form-check-label" for="service${service.id}">
                                ${service.name}
                            </label>
                        </div>
                        <span class="badge bg-primary">â‚¹${service.price}</span>
                    </div>
                `;
                container.appendChild(div);
            });
            // End Mock

            // Actual Fetch (Uncomment and implement when API is ready)
            /*
            try {
                const response = await fetch(`${API_BASE_URL}/services`);
                // ... handle response and set localServicesCache
            } catch (error) {
                // ... handle error
            }
            */
        }

        // Add Custom Service (POST /api/services) - Placeholder for brevity, assuming this works
        async function addCustomService() {
            // ... implementation
            alert("Custom service functionality is a placeholder in this version.");
        }

        // Function to populate form fields with customer data
        function populateCustomerForm(data) {
            document.getElementById('customerName').value = data.name || '';
            document.getElementById('mobileNumber').value = data.mobile || '';

            // Set the Vehicle Number in the readonly display field
            document.getElementById('vehicleNumberDisplay').value = data.vehicleNumber ? data.vehicleNumber.toUpperCase() : '';

            const vehicleTypeSelect = document.getElementById('vehicleType');
            // Normalize and set vehicle type
            const type = data.vehicleType ? data.vehicleType.toUpperCase() : '';
            const validTypes = ['CAR', 'SUV', 'BIKE', 'OTHER'];

            // Check if the type is in the options, otherwise default to empty
            vehicleTypeSelect.value = validTypes.includes(type) ? type : '';

            // Update the bill preview
            updateBillPreviewCustomer();
        }

        // Function to update the customer info section of the Bill Preview
        function updateBillPreviewCustomer() {
            const name = document.getElementById('customerName').value || '-';
            const mobile = document.getElementById('mobileNumber').value || '-';
            // Get from the readonly field which is set by searchVehicle
            const vehicleNum = document.getElementById('vehicleNumberDisplay').value || '-';

            document.getElementById('previewCustomer').textContent = name;
            document.getElementById('previewMobile').textContent = mobile;
            document.getElementById('previewVehicle').textContent = vehicleNum;
        }

        /**
         * UPDATED: Vehicle Search (GET http://15.206.90.104/api/customers?vehicleNumber=...)
         * This function handles the fetch call and updates the form.
         */
        async function searchVehicle() {
            const vehicleInput = document.getElementById('vehicleNumber');
            const vehicleNum = vehicleInput.value.toUpperCase().trim();
            const button = document.getElementById('searchVehicleBtn');

            if (!vehicleNum) {
                alert('Please enter a vehicle number.');
                return;
            }

            // Important: Clear the display field and form inputs before search
            populateCustomerForm({ vehicleNumber: vehicleNum, name: '', mobile: '', vehicleType: '' });

            setLoading(button, true);

            const url = `${CUSTOMER_SEARCH_URL}?vehicleNumber=${vehicleNum}`;

            try {
                const response = await fetch(url);

                if (response.ok) {
                    const data = await response.json();

                    if (data && data.vehicleNumber) {
                        // Customer found
                        populateCustomerForm(data);
                        alert(`Customer found for vehicle ${vehicleNum}.`);
                    } else {
                        // API returned 200 but no valid customer data (e.g., empty array or object)
                        alert(`No existing customer found for vehicle ${vehicleNum}. Please enter details.`);
                        populateCustomerForm({ vehicleNumber: vehicleNum });
                    }
                } else if (response.status === 404) {
                    // API returned 404 Not Found
                    alert(`No existing customer found for vehicle ${vehicleNum}. Please enter details.`);
                    populateCustomerForm({ vehicleNumber: vehicleNum });
                }
                else {
                    // Other HTTP error
                    throw new Error(`API returned status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error searching vehicle:', error);
                alert('Failed to connect to the customer API. Check console for details.');
                populateCustomerForm({ vehicleNumber: vehicleNum }); // Fallback to entering the vehicle number
            } finally {
                setLoading(button, false);
            }
        }

        // Update Bill Preview (Recalculate Total and Services List)
        function updateBillPreview() {
            updateBillPreviewCustomer(); // Ensure customer info is fresh

            const checkedServiceBoxes = document.querySelectorAll('#servicesList input[type="checkbox"]:checked');
            let total = 0;
            let previewHtml = '';

            if (checkedServiceBoxes.length === 0) {
                previewHtml = '<p class="text-muted">No services selected</p>';
            } else {
                previewHtml = '<ul class="list-unstyled small">';
                checkedServiceBoxes.forEach(cb => {
                    const serviceId = parseInt(cb.value);
                    const service = localServicesCache.find(s => s.id === serviceId);
                    if (service) {
                        total += service.price;
                        previewHtml += `<li>${service.name} <span class="float-end">â‚¹${service.price}</span></li>`;
                    }
                });
                previewHtml += '</ul>';
            }

            document.getElementById('previewServices').innerHTML = previewHtml;
            document.getElementById('totalAmount').textContent = total.toFixed(0);
        }

        // Placeholder functions for other parts of the application
        async function loadEmployees() { /* ... implementation */ }
        async function updateDashboard() { /* ... implementation */ }
        async function saveEmployee() { /* ... implementation */ }
        async function loadReports() { /* ... implementation */ }
        async function saveBill() {
            alert("Bill Save functionality is a placeholder in this version.");
        }
        function printBill() {
            alert("Print functionality is a placeholder in this version.");
        }

    </script>
</body>
</html>